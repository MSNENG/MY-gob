<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>أخبار الضاحية</title>

  <style>
    body {
      font-family: 'Cairo', sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f0f0f0;
      direction: rtl;
      text-align: center;
    }
    header {
      background-color: #6200ea;
      color: white;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-radius: 8px;
      margin-bottom: 30px;
    }
    .logout-btn {
      background-color: #e53935;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 10px;
      cursor: pointer;
    }
    .form-container, .comments-section {
      max-width: 600px;
      margin: 20px auto;
      background: #fff;
      padding: 20px;
      border-radius: 10px;
    }
    textarea {
      width: 100%; height: 100px;
      padding: 10px; font-size: 16px;
      border-radius: 8px; border: 1px solid #ccc;
      margin-bottom: 10px;
    }
    input[type="file"] { margin-top: 10px; }
    button { padding: 10px 20px; margin-top: 10px;
      background-color: #6200ea;
      color: white; border: none;
      border-radius: 8px; cursor: pointer; }
    .comment {
      border-bottom: 1px solid #ccc;
      text-align: right;
      padding: 10px;
    }
    .comment img { max-width: 100%; margin-top: 10px; border-radius: 8px; }
    .comment-buttons { margin-top: 5px; }
    .comment-buttons button { margin-left: 10px; }
  </style>
</head>
<body>
  <header>
    <span>مرحبًا، <span id="user-name">...</span></span>
    <button id="logout-btn" class="logout-btn">تسجيل الخروج</button>
  </header>

  <div class="form-container">
    <h2>أخبار الضاحية</h2>
    <textarea id="commentText" placeholder="اكتب تعليقك هنا..."></textarea>
    <input type="file" id="imageInput" accept="image/*" />
    <button onclick="sendComment()">إرسال التعليق</button>
  </div>

  <div class="comments-section" id="comments"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, serverTimestamp, doc, updateDoc, deleteDoc, getDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-storage.js";

    const app = initializeApp({
      apiKey: "AIzaSyCLOEjRfXigGXljIiANe22x_SXRQDQKmbs",
      authDomain: "my-gob.firebaseapp.com",
      projectId: "my-gob",
      storageBucket: "my-gob.appspot.com",
      messagingSenderId: "464127979375",
      appId: "1:464127979375:web:dccc4c8ee64738cbac029a"
    });

    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    let userNameSpan, currentUser;

    onAuthStateChanged(auth, async (user) => {
      if (!user) return location.href = "index.html";
      currentUser = user;
      const userRef = doc(db, "users", user.uid);
      const docSnap = await getDoc(userRef);
      if (!docSnap.exists()) return alert("لم يتم العثور على بيانات المستخدم.");

      const userData = docSnap.data();
      userNameSpan = document.getElementById("user-name");
      userNameSpan.textContent = userData.name || "مستخدم";
      loadComments();
    });

    document.getElementById("logout-btn").onclick = async () => {
      await signOut(auth);
      location.href = "index.html";
    };

    async function sendComment() {
      const text = document.getElementById("commentText").value;
      const file = document.getElementById("imageInput").files[0];
      if (!text.trim()) return alert("يرجى كتابة تعليق");

      let imageUrl = "";
      if (file) {
        const imageRef = ref(storage, `news_images/${Date.now()}_${file.name}`);
        await uploadBytes(imageRef, file);
        imageUrl = await getDownloadURL(imageRef);
      }

      await addDoc(collection(db, "news-comments"), {
        text, imageUrl,
        userName: userNameSpan.textContent,
        userId: currentUser.uid,
        timestamp: serverTimestamp()
      });

      document.getElementById("commentText").value = "";
      document.getElementById("imageInput").value = "";
      loadComments();
    }

    async function loadComments() {
      const commentsDiv = document.getElementById("comments");
      commentsDiv.innerHTML = "";
      const q = query(collection(db, "news-comments"), orderBy("timestamp", "desc"));
      const snapshot = await getDocs(q);

      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const div = document.createElement("div");
        div.className = "comment";

        div.innerHTML = `
          <strong>${data.userName}</strong><br>
          <p>${data.text}</p>
          ${data.imageUrl ? `<img src="${data.imageUrl}" alt="صورة التعليق" />` : ""}
        `;

        if (data.userId === currentUser.uid) {
          const btns = document.createElement("div");
          btns.className = "comment-buttons";
          const editBtn = document.createElement("button");
          editBtn.textContent = "تعديل";
          editBtn.onclick = () => editComment(docSnap.id, data.text);
          btns.appendChild(editBtn);
          div.appendChild(btns);
        }

        // للمشرف: حذف التعليق
        if (currentUser.email === "admin@example.com") {
          const deleteBtn = document.createElement("button");
          deleteBtn.textContent = "حذف";
          deleteBtn.onclick = async () => {
            if (confirm("هل أنت متأكد من حذف التعليق؟")) {
              await deleteDoc(doc(db, "news-comments", docSnap.id));
              loadComments();
            }
          };
          div.appendChild(deleteBtn);
        }

        commentsDiv.appendChild(div);
      });
    }

    function editComment(id, oldText) {
      const newText = prompt("تعديل التعليق:", oldText);
      if (newText && newText.trim()) {
        updateDoc(doc(db, "news-comments", id), { text: newText });
        loadComments();
      }
    }
  </script>
</body>
</html>
