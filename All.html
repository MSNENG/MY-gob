<!-- ... نفس رأس الصفحة السابقة ... -->

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCLOEjRfXigGXljIiANe22x_SXRQDQKmbs",
    authDomain: "my-gob.firebaseapp.com",
    projectId: "my-gob",
    storageBucket: "my-gob.appspot.com",
    messagingSenderId: "464127979375",
    appId: "1:464127979375:web:dccc4c8ee64738cbac029a"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();

  const collectionsMap = {
    "messages": "رسالة",
    "news-comments": "أخبار الضاحية",
    "General-news": "أخبار عامة",
    "article-page": "أخبار عاجلة",
    "talents-comments": "مواهب",
    "clarifications-comments": "إستفسارات",
    "AD-comments": "إعلانات",
    "question-comments": "مقالات أهل الضاحية"
  };

  const collections = Object.keys(collectionsMap);

  async function fetchComments(user) {
    const commentsList = document.getElementById("commentsList");
    commentsList.innerHTML = ""; // تفريغ القائمة قبل العرض

    const allComments = [];

    // جلب دور المستخدم
    let isAdmin = false;
    if (user) {
      const userDoc = await db.collection("users").doc(user.uid).get();
      isAdmin = userDoc.exists && userDoc.data().role === "admin";
    }

    for (let collectionName of collections) {
      const snapshot = await db.collection(collectionName)
        .orderBy("timestamp", "desc")
        .get();

      snapshot.forEach(doc => {
        const data = doc.data();
        const comment = {
          id: doc.id,
          collection: collectionName,
          text: data.text,
          imageUrl: data.imageUrl,
          userName: data.userName || "مستخدم مجهول",
          section: collectionsMap[collectionName],
          timestamp: data.timestamp?.toDate()
        };
        allComments.push(comment);
      });
    }

    allComments.sort((a, b) => b.timestamp - a.timestamp);

    allComments.forEach(comment => {
      const commentDiv = document.createElement("div");
      commentDiv.className = "comment";

      const formattedDate = comment.timestamp ? comment.timestamp.toLocaleString("ar-EG") : "غير متوفر";

      commentDiv.innerHTML = `
        <strong>${comment.userName}</strong><br/>
        ${comment.text || ""}<br/>
        <small>${formattedDate}</small><br/>
        <div class="section-name">القسم: ${comment.section}</div>
      `;

      if (comment.imageUrl) {
        const img = document.createElement("img");
        img.src = comment.imageUrl;
        commentDiv.appendChild(img);
      }

      // زر الحذف للمشرف فقط
      if (isAdmin) {
        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "🗑 حذف";
        deleteBtn.style.marginTop = "10px";
        deleteBtn.style.backgroundColor = "#e53935";
        deleteBtn.style.color = "white";
        deleteBtn.style.border = "none";
        deleteBtn.style.padding = "5px 10px";
        deleteBtn.style.borderRadius = "5px";
        deleteBtn.style.cursor = "pointer";

        deleteBtn.onclick = async () => {
          if (confirm("هل أنت متأكد أنك تريد حذف هذا التعليق؟")) {
            await db.collection(comment.collection).doc(comment.id).delete();
            commentDiv.remove();
          }
        };
        commentDiv.appendChild(deleteBtn);
      }

      commentsList.appendChild(commentDiv);
    });
  }

  auth.onAuthStateChanged(user => {
    fetchComments(user);
  });
</script>
