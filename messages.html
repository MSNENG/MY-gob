function listenToMessages() {
  const messagesList = document.getElementById("messagesList");

  db.collection("messages").orderBy("timestamp", "desc").onSnapshot((snapshot) => {
    messagesList.innerHTML = "";

    if (snapshot.empty) {
      messagesList.innerHTML = "<p>لا توجد رسائل بعد.</p>";
      return;
    }

    snapshot.forEach((doc) => {
      const data = doc.data();
      const messageDiv = document.createElement("div");
      messageDiv.className = "message";

      const date = data.timestamp?.toDate?.();
      const formattedDate = date ? date.toLocaleString("ar-EG") : "غير متوفر";

      // عنصر لعرض النص
      const messageText = document.createElement("span");
      messageText.textContent = data.text;

      // حاوية الرسالة
      messageDiv.innerHTML = `
        <strong>${data.userName || "مستخدم مجهول"}</strong><br/>
      `;
      messageDiv.appendChild(messageText);
      messageDiv.innerHTML += `<br/><small>${formattedDate}</small>`;

      // زر الحذف للمشرفين
      if (isAdmin) {
        const deleteBtn = document.createElement("button");
        deleteBtn.className = "delete-btn";
        deleteBtn.textContent = "حذف";
        deleteBtn.onclick = async () => {
          const confirmDelete = confirm("هل أنت متأكد من حذف هذا التعليق؟");
          if (confirmDelete) {
            try {
              await db.collection("messages").doc(doc.id).delete();
              alert("تم حذف الرسالة بنجاح");
            } catch (error) {
              console.error("خطأ أثناء حذف الرسالة:", error);
              alert("حدث خطأ أثناء حذف الرسالة");
            }
          }
        };
        messageDiv.appendChild(deleteBtn);
      }

      // زر التعديل إذا كان المستخدم هو صاحب الرسالة
      if (data.userId === currentUser.uid) {
        const editBtn = document.createElement("button");
        editBtn.className = "delete-btn";
        editBtn.style.left = "70px";
        editBtn.textContent = "تعديل";

        editBtn.onclick = () => {
          // إنشاء حقل الإدخال وزر الحفظ
          const input = document.createElement("textarea");
          input.value = data.text;
          input.style.width = "100%";
          input.style.marginTop = "10px";

          const saveBtn = document.createElement("button");
          saveBtn.textContent = "حفظ";
          saveBtn.style.marginTop = "10px";

          // استبدال النص بالحقل وزر الحفظ
          messageDiv.replaceChild(input, messageText);
          messageDiv.appendChild(saveBtn);

          saveBtn.onclick = async () => {
            const newText = input.value.trim();
            if (!newText) {
              alert("النص لا يمكن أن يكون فارغًا");
              return;
            }
            if (newText.length > 160) {
              alert("يجب ألا تتجاوز الرسالة 160 حرفًا");
              return;
            }

            try {
              await db.collection("messages").doc(doc.id).update({
                text: newText
              });
              alert("تم تعديل الرسالة بنجاح");
            } catch (error) {
              console.error("خطأ أثناء التعديل:", error);
              alert("حدث خطأ أثناء تعديل الرسالة");
            }
          };
        };

        messageDiv.appendChild(editBtn);
      }

      messagesList.appendChild(messageDiv);
    });
  });
}
