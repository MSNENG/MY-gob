<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
  import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, deleteDoc, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCLOEjRfXigGXljIiANe22x_SXRQDQKmbs",
    authDomain: "my-gob.firebaseapp.com",
    projectId: "my-gob",
    storageBucket: "my-gob.appspot.com",
    messagingSenderId: "464127979375",
    appId: "1:464127979375:web:dccc4c8ee64738cbac029a",
    measurementId: "G-W2XBV7XH66"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentUser = null;
  let isAdmin = false;

  onAuthStateChanged(auth, (user) => {
    if (user) {
      currentUser = user;
      checkIfAdmin(user.uid).then(() => {
        listenToMessages();
      });
    } else {
      window.location.href = "index.html";
    }
  });

  // âœ… Ø¯Ø§Ù„Ø© async Ù…Ù†ÙØµÙ„Ø© Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙˆÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø´Ø±Ù
  async function checkIfAdmin(uid) {
    try {
      const userDoc = await getDoc(doc(db, "users", uid));
      if (userDoc.exists()) {
        const data = userDoc.data();
        isAdmin = data.role === "admin";
      }
    } catch (error) {
      console.error("ÙØ´Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª:", error);
    }
  }

  async function sendMessage() {
    const input = document.getElementById("messageInput");
    const messageText = input.value.trim();

    if (!messageText) {
      alert("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© ØªØ¹Ù„ÙŠÙ‚ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„");
      return;
    }

    try {
      await addDoc(collection(db, "messages"), {
        text: messageText,
        userEmail: currentUser.email,
        timestamp: serverTimestamp()
      });

      input.value = "";
    } catch (error) {
      alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©: " + error.message);
    }
  }

  function listenToMessages() {
    const messagesList = document.getElementById("messagesList");
    const q = query(collection(db, "messages"), orderBy("timestamp", "desc"));

    onSnapshot(q, (snapshot) => {
      messagesList.innerHTML = "";
      snapshot.forEach((docSnap) => {
        const msg = docSnap.data();
        const id = docSnap.id;

        const item = document.createElement("div");
        item.className = "message";
        item.innerHTML = `
          <strong>${msg.userEmail}</strong><br/>
          <span>${msg.text}</span><br/>
          <small>${msg.timestamp?.toDate().toLocaleString("ar-EG") || ""}</small>
          ${isAdmin ? `<br/><button onclick="deleteMessage('${id}')">ğŸ—‘ Ø­Ø°Ù</button>` : ""}
        `;
        messagesList.appendChild(item);
      });
    });
  }

  window.deleteMessage = async function (id) {
    if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ØŸ")) {
      try {
        await deleteDoc(doc(db, "messages", id));
      } catch (error) {
        alert("ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù: " + error.message);
      }
    }
  };

  window.sendMessage = sendMessage;
</script>
