<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>أسئلة مطروحة</title>

  <!-- استدعاء مكتبات Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { getFirestore, collection, doc, getDoc, getDocs, addDoc, updateDoc, deleteDoc, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCLOEjRfXigGXljIiANe22x_SXRQDQKmbs",
      authDomain: "my-gob.firebaseapp.com",
      projectId: "my-gob",
      storageBucket: "my-gob.appspot.com",
      messagingSenderId: "464127979375",
      appId: "1:464127979375:web:dccc4c8ee64738cbac029a"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;
    let isAdmin = false;

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "index.html";
        return;
      }

      currentUser = user;
      let userNameSpan = document.getElementById("user-name");
      const userRef = doc(db, "users", user.uid);
      const docSnap = await getDoc(userRef);

      if (docSnap.exists()) {
        const data = docSnap.data();
        userNameSpan.textContent = data.name || "مستخدم";
        isAdmin = data.role === "admin";
      }

      loadQuestions();
    });

    // تحميل الأسئلة
    async function loadQuestions() {
      const container = document.getElementById('questions-container');
      container.innerHTML = "";

      const qSnapshot = await getDocs(query(collection(db, "question-comments"), orderBy("timestamp", "desc")));

      for (const docSnap of qSnapshot.docs) {
        const data = docSnap.data();
        const commentId = docSnap.id;

        const questionDiv = document.createElement("div");
        questionDiv.classList.add("comment");

        const time = new Date(data.timestamp?.seconds * 1000).toLocaleString();
        const contentP = document.createElement("p");
        contentP.textContent = data.text;

        questionDiv.innerHTML = `<strong>سؤال بتاريخ: ${time}</strong>`;
        questionDiv.appendChild(contentP);

        // أزرار التعديل والحذف (للمشرف أو المالك فقط)
        if (isAdmin || data.userId === currentUser.uid) {
          const editBtn = document.createElement("button");
          editBtn.textContent = "تعديل";
          editBtn.onclick = async () => {
            const newText = prompt("تعديل السؤال:", data.text);
            if (newText && newText.trim() !== "") {
              await updateDoc(doc(db, "question-comments", commentId), {
                text: newText.trim()
              });
              loadQuestions();
            }
          };

          const deleteBtn = document.createElement("button");
          deleteBtn.textContent = "حذف";
          deleteBtn.style.marginRight = "10px";
          deleteBtn.onclick = async () => {
            if (confirm("هل أنت متأكد من حذف السؤال؟")) {
              await deleteDoc(doc(db, "question-comments", commentId));
              loadQuestions();
            }
          };

          questionDiv.appendChild(editBtn);
          questionDiv.appendChild(deleteBtn);
        }

        // حقل الرد
        const replyInput = document.createElement("input");
        replyInput.placeholder = "أضف تعقيبًا...";
        replyInput.className = "reply-input";

        const replyBtn = document.createElement("button");
        replyBtn.textContent = "إرسال تعقيب";
        replyBtn.className = "reply-btn";
        replyBtn.onclick = async () => {
          if (replyInput.value.trim() === "") return;
          await addDoc(collection(db, `question-comments/${commentId}/replies`), {
            text: replyInput.value,
            timestamp: serverTimestamp(),
            userId: currentUser.uid,
          });
          replyInput.value = "";
          loadQuestions();
        };

        questionDiv.appendChild(replyInput);
        questionDiv.appendChild(replyBtn);

        // التعقيبات
        const repliesSnapshot = await getDocs(query(collection(db, `question-comments/${commentId}/replies`), orderBy("timestamp", "asc")));
        for (const replyDoc of repliesSnapshot.docs) {
          const replyData = replyDoc.data();
          const replyId = replyDoc.id;
          const replyTime = new Date(replyData.timestamp?.seconds * 1000).toLocaleString();

          const replyBox = document.createElement("div");
          replyBox.className = "reply-box";
          replyBox.innerHTML = `<small>تعقيب بتاريخ ${replyTime}:</small> ${replyData.text}`;

          // أزرار التعديل والحذف للتعقيبات
          if (isAdmin || replyData.userId === currentUser.uid) {
            const editReplyBtn = document.createElement("button");
            editReplyBtn.textContent = "تعديل";
            editReplyBtn.onclick = async () => {
              const newText = prompt("تعديل التعقيب:", replyData.text);
              if (newText && newText.trim() !== "") {
                await updateDoc(doc(db, `question-comments/${commentId}/replies/${replyId}`), {
                  text: newText.trim()
                });
                loadQuestions();
              }
            };

            const deleteReplyBtn = document.createElement("button");
            deleteReplyBtn.textContent = "حذف";
            deleteReplyBtn.style.marginRight = "10px";
            deleteReplyBtn.onclick = async () => {
              if (confirm("هل أنت متأكد من حذف التعقيب؟")) {
                await deleteDoc(doc(db, `question-comments/${commentId}/replies/${replyId}`));
                loadQuestions();
              }
            };

            replyBox.appendChild(editReplyBtn);
            replyBox.appendChild(deleteReplyBtn);
          }

          questionDiv.appendChild(replyBox);
        }

        container.appendChild(questionDiv);
      }
    }

    // وظيفة تسجيل الخروج
    function logout() {
      signOut(auth).then(() => {
        window.location.href = "index.html"; // العودة إلى الصفحة الرئيسية
      }).catch((error) => {
        console.error("خطأ أثناء تسجيل الخروج:", error);
      });
    }

    // إضافة تعليق جديد
    async function addComment() {
      const newCommentInput = document.getElementById("new-comment-input");
      const newText = newCommentInput.value.trim();
      if (newText) {
        await addDoc(collection(db, "question-comments"), {
          text: newText,
          timestamp: serverTimestamp(),
          userId: currentUser.uid,
        });
        newCommentInput.value = ""; // مسح الحقل بعد الإرسال
        loadQuestions(); // إعادة تحميل الأسئلة
      }
    }
  </script>

  <style>
    body {
      font-family: 'Arial', sans-serif;
      background-color: #f9f9f9;
      color: #333;
      margin: 0;
      padding: 0;
    }

    header {
      background-color: #6a1b9a;
      color: white;
      padding: 10px 20px;
      text-align: right;
    }

    header span {
      margin-left: 10px;
      font-size: 20px;
    }

    .logout-btn {
      background-color: #f44336;
      color: white;
      border: none;
      padding: 10px 15px;
      cursor: pointer;
      font-size: 14px;
      border-radius: 5px;
      transition: background-color 0.3s;
    }

    .logout-btn:hover {
      background-color: #e53935;
    }

    #questions-container {
      padding: 20px;
    }

    .comment {
      background-color: #fff;
      margin-bottom: 20px;
      padding: 15px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .comment strong {
      font-size: 16px;
      color: #6a1b9a;
    }

    .reply-box {
      background-color: #f1f1f1;
      padding: 10px;
      margin-top: 10px;
      border-radius: 5px;
    }

    .reply-input, .reply-btn, #new-comment-input, #add-comment-btn {
      padding: 10px;
      margin-top: 10px;
      width: 100%;
      box-sizing: border-box;
    }

    .reply-btn {
      background-color: #28a745;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 5px;
      transition: background-color 0.3s;
    }

    .reply-btn:hover {
      background-color: #218838;
    }

    .comment button {
      background-color: #6a1b9a;
      color: white;
      border: none;
      padding: 5px 10px;
      cursor: pointer;
      border-radius: 5px;
      margin: 5px;
    }

    .comment button:hover {
      background-color: #4a148c;
    }

    /* حقل إضافة تعليق جديد */
    #new-comment-container {
      background-color: #fff;
      padding: 15px;
      margin-bottom: 20px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      border-radius: 5px;
    }

    #add-comment-btn {
      background-color: #6a1b9a;
      color: white;
      border: none;
      cursor: pointer;
      padding: 10px 15px;
      border-radius: 5px;
      width: 100%;
    }

    #add-comment-btn:hover {
      background-color: #4a148c;
    }
  </style>
</head>

<body>

  <header>
    <span id="user-name"></span>
    <button class="logout-btn" onclick="logout()">تسجيل الخروج</button>
  </header>

  <!-- حقل إضافة تعليق جديد -->
  <div id="new-comment-container">
    <input type="text" id="new-comment-input" placeholder="أضف تعليقًا جديدًا..." />
    <button id="add-comment-btn" onclick="addComment()">إضافة تعليق</button>
  </div>

  <div id="questions-container"></div>

</body>
</html>
